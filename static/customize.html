<!DOCTYPE html>
<html>
<head>
	<title>Donation Aggregator Service</title>
	<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<link href="https://fonts.googleapis.com/css?family=Lato:900|Montserrat|Roboto&display=swap" rel="stylesheet">
	<link rel="stylesheet" type="text/css" href="/static/styles/customstyles.css">
	<link rel="stylesheet" type="text/css" href="/static/styles/navbar.css">
	<script>
		
		if(document.cookie.split("=")[0]!="loggedIn"){
			location.href="/login"
		}
		
	</script>
</head>
<body>
	<span id="cid" style="display: none"></span>
	<div class="navbar">
		<div class="left-bar">
			<span><i class="material-icons">home</i><a href="#">Home</a></span>
			<span><i class="material-icons">person</i><a href="http://localhost:5000/profile">Profile</a></span>
			<span><i class="material-icons">list_alt</i><a href="http://localhost:5000/events/0000">Create Event</a></span>
			<span><i class="material-icons">list_alt</i><a href="http://localhost:5000/event-listings">All Events</a></span>
		</div>
		<div class="right-bar">
			<span><a href="#">Login</a></span>
		</div>
	</div>
	<div class="registerwindow" id="register-3">
		<div class="tagcontainer">
				<p id="save-changes">Edit Page</p>
				<input class="edit-mode registerbutton" id="save-input" type="button" onclick="toggleEditingMode()" value="Edit Page">
				<p>Page color</p>
				<input type="color" onchange="colorChanger(this)" value="#3e8e3e">
		</div>
	</div>
	<div class="bgimage">
		<img src="#" id="bgimage-img">
	</div>
	
	<div class="centercontent">
		<div class="contentbody">
			<div class="contentcover">
				<div class="unloaded-cover-picture">
					<i class="material-icons">add</i>
					<input type="file" onchange="loadCoverPic(this)">
				</div>
				<div class="loaded-cover-picture">
					<img src="#">
				</div>
				<div class="follow-nav">
					<div class="follower-count">
						<h3 id="follow-count">0</h3>
					</div>
					<div class="follow">
						<input id="follow-btn" type="button" value="Follow" onclick="increaseFol()">
					</div>
				</div>
			</div>
			
			<div class="contentbox overridegrid content-border">
				<div class="eventorganizer">
					<h3 id="foundation-name" >Ninaada Foundation</h3>
				</div>
				<div class="eventlocation">
					<i class="material-icons">my_location</i>
					<input class="material-ip" id="location-id" value="Cubbon Park, Bangalore 560011">
				</div>				
			</div>
			<div class="contentbox">
				<div class="element-div">
					<div class="h3-container">
						<h3 class="about"  contenteditable="false" spellcheck="false"> Our Events</h3>
						<button  onclick="delElement(this)"> <i class="material-icons">close</i></button>
					</div>
					<p class="small-text" id="about-us" contenteditable="false" spellcheck="false">"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum."</p>
				</div>
			</div>
			<div class="contentbox">
				<div class="element-div">
					<div class="h3-container" id="widget-row-x">
						<button  onclick="delElement(this)"> <i class="material-icons">close</i></button>
					</div>
					<div class="flex-row-box">
						<div class="frame-box" onclick="loadWidgetMenu(this)">
							<div class="frame-button">
								<i class="material-icons">add</i>
							</div>
							<iframe class="custom-widget" src=""></iframe>
						</div>
						<div class="frame-box" onclick="loadWidgetMenu(this)">
							<div class="frame-button">
								<i class="material-icons">add</i>
							</div>
							<iframe class="custom-widget" src=""></iframe>
						</div>
					</div>
				</div>
			</div>		
			<div class="contentbox">
				<div class="element-div">
					<div class="h3-container">
						<h3 class="about"  contenteditable="false" spellcheck="false"> Past Events</h3>
						<button  onclick="delImgRow(this)	"> <i class="material-icons">close</i></button>
					</div>
					<div class="flex-col-box">
						
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="widget-menu" id="widget-menu-1">
		<div class="close-div" onclick="loadWidgetMenu('close')">
			<h3>Widgets</h3>
			<i class="material-icons close-widget">close</i>
		</div>
		<div class="widgets" id="widget-1" onclick="addWidget('calendar')">
			<h3>Calendar</h3>
		</div>
		<div class="widgets" id="widget-1" onclick="addWidget('quote')">
			<h3>Quotes</h3>
		</div>
	</div>

		
	

	<script>


            var componentToggle = false
            var widgetToggle = false
            var selectedFrame = null
            var editMode = false
			var imageRows = 0
			var currentColor = "#3e8e3e"
            function loadComponentMenu(){
                componentToggle = !componentToggle
                if(componentToggle && widgetToggle){
                    $("#widget-menu-2").animate({"right":"0"},"fast")
                    $("#widget-menu-1").animate({"right":"-350"},"fast")
					$(".registerwindow").animate({"right":"80px"},"fast")
                    widgetToggle = false
                }else{
                    if(componentToggle){
                        $("body").animate({"left":"-250px"},"fast")
						$(".registerwindow").animate({"right":"330px"},"fast")
                        $("#widget-menu-2").animate({"right":"0"},"fast")
                    }
                    else{
                        $("body").animate({"left":"0px"},"fast")
						$(".registerwindow").animate({"right":"80px"},"fast")
                        $("#widget-menu-2").animate({"right":"-350"},"fast")
                    }
                    
                }
                
            
            }


			$(".editable-p").on("focus",function(){
				if($(this).html()=="Sample Text"){
					$(this).html("&zwnj;")
				}
			})

			$(".editable-p").on("blur",function(){
				if($(this).html()=="\u200c"){
					$(this).html("Sample Text")
				}
			})

			$("body").ready(function(){

				//TODO
				
				/*$("body").css({"opacity":"0"})
				$.ajax({
					url:"callMalaikaFunction",
					method:"post",
					data:JSON.stringify({"eid":$("#eid").text()}),
					success:function(data){
						console.log("Received page data")
						pageBuilder(data)
					}
				})*/
				
				
			})

			function getBase64Image(img) {
				var canvas = document.createElement("canvas");
				canvas.width = img.width;
				canvas.height = img.height;
				var ctx = canvas.getContext("2d");
				ctx.drawImage(img, 0, 0);
				var dataURL = canvas.toDataURL("image/png");
				return dataURL.replace(/^data:image\/(png|jpg);base64,/, "");
			}

			function pageBuilder(data){
				var cookie = document.cookie.split("=")[1]
				if(data["cid"]!=cookie){
					$("#register-3").remove()
				}
				colorReplace(0,data["color"])
				data["tags"].forEach((ind,ele)=>{
					$(".tag-holder").append($("<p></p>").attr("class","tag").attr("id",ele).text(ele))
				})
				$("#foundation-name").text(data["foundation-name"])
				$("#event-title").text(data["event-name"])
				$("#event-head").text(data["event-head"])
				$("#event-details").text(data["event-details"])
				$("#location-name").text(data["location-name"])
				$("#location-link").text(data["location-link"])
				$("#event-date").text(data["event-date"])
				$("#phone-no").text(data["phone-no"])
				$("#contact-name").text(data["contact-name"])
				$("body").css({"opacity":"1"})
				}

            
            function callLoaders(){
                followCount()
            }

            function delElement(ref){
                $(ref).parent().parent().parent().slideUp(350,function(){
                    $(this).remove()
                })

            }

			function delImgRow(ob){
				$(ob).parent().slideUp(function(){
					$(ob).parent().remove()
				})
			}

            function loadCoverPic(input){
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $($(input).parent().parent().children(".loaded-cover-picture").children()[0]).attr('src', e.target.result);
                        $(input).parent().parent().children(".loaded-cover-picture").show()
                        $(input).parent().css({"opacity":"0"})
						$("#bgimage-img").attr("src",e.target.result)
						$("body").css({"background":"none"})
                    };

                    reader.readAsDataURL(input.files[0]);
                }
            }

			function increaseFol(){
				$.ajax({
					url:"http://localhost:5000/followers",
					method:"post",
					data:JSON.stringify({"CharityID":$("#cid").text()}),
					contentType:"application/json",
					success:function(data){
						$("#follow-count").text(parseInt($("#follow-count").text())+1)
					}
				})
			}

            function loadImage(input) {
                if (input.files && input.files[0]) {
                    var reader = new FileReader();

                    reader.onload = function (e) {
                        $($(input).parent().parent().children(".img-container-loaded").children()[0]).attr('src', e.target.result);
                        $(input).parent().parent().children(".img-container-loaded").show()
                        $(input).parent().css({"opacity":"0"})
                    };

                    reader.readAsDataURL(input.files[0]);
                }
            }
            
            function loadWidgetMenu(frameParent){
                widgetToggle = true
                if(componentToggle && widgetToggle){
                    $("#widget-menu-1").animate({"right":"0"},"fast")
                    $("#widget-menu-2").animate({"right":"-330px"},"fast")
					$(".registerwindow").animate({"right":"80px"},"fast")
                    componentToggle = false
                }
                else{
                    if(frameParent=='close'){
                        $("body").animate({"left":"0px"},"fast")
                        $("#widget-menu-1").animate({"right":"-330px"},"fast")
						$(".registerwindow").animate({"right":"80px"},"fast")
                        widgetToggle = false
                    }
                    else{
                        $("body").animate({"left":"-250px"},"fast")
                        $("#widget-menu-1").animate({"right":"0"},"fast")
						$(".registerwindow").animate({"right":"330px"},"fast")
                        widgetToggle = true
                        
                    }

                }
                selectedFrame = frameParent
            }


            function addWidget(path){
                $($(selectedFrame).children()[1]).attr("src","http://localhost:5000/1234/"+path)
                $($(selectedFrame).children()[0]).hide()
            }

        

			var totFollows = 0

			$(document).ready(function(){
				var data = document.cookie.split("=")[1]
				$("#cid").text(data)
				$.ajax({
					url:"/followers",
					method:"get",
					data:{"CharityID":$("#cid").text()},
					contentType:"application/json",
					success:function(data){
						totFollows = parseInt(data)
						currFollows = totFollows - 60
						if(currFollows < 0){
							currFollows = 0
						}
						$("#follow-count").text(currFollows)
						followCounterInterval = setInterval(followCount,20)
					}
				})
			})
				
			$("body").ready(function(){
				
				var cid = window.location.href.split("/")[window.location.href.split("/").length-1]
				if(cid!="0000"){
					$("body").css({"opacity":"0"})
					$.ajax({
						url:"http://localhost:5000/list-events",
						success:function(data){
							data.forEach((ele)=>{
								buildPrevEvents('data:image/png;base64,'+ele["cover-picture"],ele["event-details"],ele["event-head"])
							})
						}
					})
					$.ajax({
						url:"http://localhost:5000/charitydata/"+cid,
						method:"post",
						dataType:"json",
						success:function(data){
							buildPage(data)
						}
					})
				}
				
			})

			function buildPage(data){
				console.log(data)
				$("#location-id").val(data["location-id"])
				$("#foundation-name").text(data["foundation-name"])
				var wid = $(".custom-widget");
				wid.each((ind, element)=>{
					$(element).attr("src", data["widgets"][ind])
					$($(element).parent().find(".frame-button")).hide()
				})
				colorChanger("#3e8e3e",data["color"])
				$("#about-us").text(data["about-us"])
				$("body").css({"opacity":"1"})
			}

			function buildPrevEvents(img,dets,title){
				if(imageRows%2==0)
					{
						console.log("here1",imageRows)
                        $(".flex-col-box").append(`<div class="image-row image-row-odd">
													<div class="event-box">
														<div class="img-container-loaded">
															<img class="card-img" src="`+img+`">
														</div>
													</div>
													<div class="text-box">
														<h4 class="event-desc" contenteditable="false" spellcheck="false">`+title+`</h4>
														<p class="event-desc" contenteditable="false" spellcheck="false">`+dets+`</p>
													</div>
													<button class="del-btn" onclick="delImgRow(this)"> <i class="material-icons">close</i></button>
												</div>`)
					}
						
												else{
													console.log("here2",imageRows)
						$(".flex-col-box").append(`<div class="image-row image-row-even">
													<div class="text-box">
														<h4 class="event-desc" contenteditable="false" spellcheck="false">`+title+`</h4>
														<p class="event-desc" contenteditable="false" spellcheck="false">`+dets+`</p>
													</div>
													<div class="event-box">
														<div class="img-container-loaded">
															<img class="card-img" src="`+img+`">
														</div>
													</div>
													<button class="del-btn" onclick="delImgRow(this)"> <i class="material-icons">close</i></button>
												</div>`)
												}
						imageRows++
			}

            function followCount(){
                if($("#follow-count").text()==totFollows){
                    clearInterval(followCounterInterval)
                }
				else{
					$("#follow-count").text(parseInt($("#follow-count").text())+1)
				}	
				
            }



			function saveData(){

				var eventsRows = $(".image-row")
				var reader = new FileReader();
				var pageData = {
					"cid":document.cookie.split("=")[1],
					"location-id":$("#location-id").val(),
					"foundation-name":$("#foundation-name").text(),
					"widgets":[],
					"color":currentColor,
					"about-us":$("#about-us").text()
				}

				var wid = $(".custom-widget");
				wid.each((ind, element)=>{
					pageData["widgets"].push($(element).attr('src'))
				})

				console.log(pageData)

				$.ajax({
					url:"http://localhost:5000/customdata/"+document.cookie.split("=")[1],
					async:true,
					method:"post",
					cache: false,
					data: JSON.stringify(pageData),
					contentType: "application/json",
					processData: false,
					success:function(){
						
						console.log("sent")
					}
				})
					
			}

            function toggleEditingMode(){
                

                if(editMode){
                    editMode = false
					$("#foundation-name").attr("contenteditable","false")
					$(".material-ip").css({"animation":"none"}).addClass("locked-input")
					$("#edit-btn").hide()
					$(".h3-container button").hide()
					$(".frame-box").css({"pointer-events":"none"})
					$("input[type='file']").css({"pointer-events":"none"})
					$(".del-btn").hide()
					$(".eventlocation").css({"animation":"none"})
					$(".small-text").css({"animation":"none"})
					$("#save-changes").text("Edit Page")
					$("#save-input").val("Edit Page")
					$("#add-component").hide()
					$(".frame-button").hide()
					saveData()
                }
                else{
                    editMode = true
					$("#foundation-name").attr("contenteditable","true")
					$(".small-text").css({"animation":"0.6s shake","animation-iteration-count":"infinite"})
					$(".material-ip").css({"animation":"0.6s shake","animation-iteration-count":"infinite"}).removeClass("locked-input")
					$("#edit-btn").show()
					$(".h3-container button").show()
					$(".frame-box").css({"pointer-events":"auto"})
					$("input[type='file']").css({"pointer-events":"auto"})
					$(".eventlocation").css({"animation":"0.6s shake","animation-iteration-count":"infinite"})
					$(".del-btn").show()
					$("#save-changes").text("Save Changes")
					$("#save-input").val("Save Changes")
					$($(".edit-mode")[0]).val("Save Changes")
					$($(".save-changes")[0]).text("Save Changes")
					$("#add-component").show()
					$(".frame-button").show()
                }
				
				$("p[contenteditable] , h3[contenteditable],h4[contenteditable]").attr("contenteditable",editMode)
            }

            

			

			function colorChanger(ob,onrender=false){
				if(onrender==false){
					colorReplace(currentColor,ob.value)
					currentColor = ob.value
				}
				else{
					colorReplace(currentColor,onrender)
					currentColor = onrender
				}				
			}
			
			function colorReplace(findHexColor, replaceWith) {
				// Convert rgb color strings to hex
				// REF: https://stackoverflow.com/a/3627747/1938889
				function rgb2hex(rgb) {
					if (/^#[0-9A-F]{6}$/i.test(rgb)) return rgb;
					rgb = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
					function hex(x) {
					return ("0" + parseInt(x).toString(16)).slice(-2);
					}
					return "#" + hex(rgb[1]) + hex(rgb[2]) + hex(rgb[3]);
				}

				// Select and run a map function on every tag
				$('*').map(function(i, el) {
					// Get the computed styles of each tag
					var styles = window.getComputedStyle(el);

					// Go through each computed style and search for "color"
					Object.keys(styles).reduce(function(acc, k) {
					var name = styles[k];
					var value = styles.getPropertyValue(name);
					if (value !== null && name.indexOf("color") >= 0) {
						// Convert the rgb color to hex and compare with the target color
						if (value.indexOf("rgb(") >= 0 && rgb2hex(value) === findHexColor) {
						// Replace the color on this found color attribute
						$(el).css(name, replaceWith);
						}
					}
					});
				});
			}
        </script>
</body>
</html>